<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云剪贴板</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23fff'/%3E%3Cpath d='M25 25h50v10H25z' fill='%23007bff'/%3E%3Cpath d='M25 40h50v45H25zm0 15h50M25 55h50M25 70h50' stroke='%23007bff' stroke-width='4' fill='none'/%3E%3C/svg%3E">
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --success: #28a745;
            --danger: #dc3545;
            --primary: #007bff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
        }

        .drag-over {
            border: 2px dashed var(--primary) !important;
            background-color: rgba(0, 123, 255, 0.05);
        }

        .file-card {
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 300px;
        }

        .file-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .content-preview {
            position: relative;
            max-height: none;
            overflow: visible;
        }

        .content-preview.has-overflow::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to bottom, transparent 0%, white 90%);
            pointer-events: none;
            z-index: 1;
        }

        .content-preview::after {
            z-index: 1;
        }

        .content-full {
            max-height: none;
            overflow: auto;
        }

        .load-more {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, transparent, white 70%);
            padding: 2rem 0 1rem;
            text-align: center;
        }

        .whitelist-icon {
            width: 18px;
            height: 18px;
            margin-right: 6px;
        }

        #toast {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pre-line {
            transition: max-height 0.3s ease;
            white-space: pre-wrap; /* 保留所有空白和换行 */
            word-break: break-word;
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            font-family: monospace;
            line-height: 1.5;
            overflow-x: auto;
        }

        .pre-line.expanded {
            max-height: none !important;
            overflow: visible;
        }

        .pre-line-container {
            position: relative;
            padding-bottom: 40px;
        }

        .show-full-btn {
            position: relative;
            z-index: 10;
            margin-top: 8px;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 20;
            opacity: 0.7;
            transition: opacity 0.2s;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }

        .copy-btn:hover {
            opacity: 1;
            background-color: #f8f9fa;
        }

        .text-content-wrapper {
            position: relative;
        }

        .copy-success {
            background-color: var(--success) !important;
            color: white !important;
            border-color: var(--success) !important;
        }

        .drop-zone-text {
            transition: all 0.3s;
        }

        .drop-zone-hint {
            font-size: 0.85rem;
            margin-top: 8px;
            color: #6c757d;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">📤 上传内容</h5>

                    <form id="uploadForm" class="mb-4">
                        <div class="mb-3">
                            <label class="form-label">文字内容</label>
                            <textarea
                                    id="textInput"
                                    name="text"
                                    class="form-control"
                                    rows="3"
                                    placeholder="输入要保存的文字..."
                            ></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">文件上传</label>
                            <input
                                    type="file"
                                    id="fileInput"
                                    name="file"
                                    class="form-control"
                            >
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <span class="upload-text">开始上传</span>
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </form>

                    <div
                            id="dropZone"
                            class="card border-dashed bg-light mb-4"
                            style="height: 160px; cursor: pointer;"
                    >
                        <div class="card-body d-flex flex-column justify-content-center text-center text-muted">
                            <div class="drop-zone-text">
                                <i class="bi bi-upload fs-3 mb-2"></i>
                                <div>拖放文件到此处上传</div>
                                <div class="drop-zone-hint">或按 Ctrl+V 粘贴图片</div>
                            </div>
                            <div id="dropPreview" class="d-none">
                                <img id="dropPreviewImage" class="img-fluid rounded mb-2" style="max-height: 100px;">
                                <div>图片已准备上传</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">📂 所有文件</h5>
                    <div id="fileList" class="row g-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast align-items-center position-fixed bottom-0 start-50 translate-x-n50 mb-4 border-0"
     role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex bg-dark text-white rounded p-3">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-3 m-auto" data-bs-dismiss="toast"></button>
    </div>
</div>

<script>
    const MAX_PREVIEW_LENGTH = 1000;
    let pastedImageFile = null;

    class Toast {
        static show(message, type = 'info') {
            const toastEl = document.getElementById('toast');
            const toastBody = toastEl.querySelector('.toast-body');
            const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-dark';
            toastEl.className = `toast show ${bgClass} text-white`;
            toastBody.textContent = message;
            setTimeout(() => toastEl.classList.remove('show'), 3000);
        }
    }

    async function uploadFile(formData) {
        const btn = document.querySelector('#uploadForm button');
        btn.disabled = true;
        btn.querySelector('.upload-text').classList.add('d-none');
        btn.querySelector('.spinner-border').classList.remove('d-none');

        try {
            const response = await fetch('/api/clipboard/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('上传失败');
            Toast.show('上传成功', 'success');
            await loadFiles();
        } catch (error) {
            Toast.show(error.message, 'danger');
        } finally {
            btn.disabled = false;
            btn.querySelector('.upload-text').classList.remove('d-none');
            btn.querySelector('.spinner-border').classList.add('d-none');
        }
    }

    async function loadFiles() {
        try {
            const response = await fetch('/api/clipboard/queryAllFiles');
            const files = await response.json();
            renderFiles(files);
            loadTextContents(files);
        } catch (error) {
            Toast.show('加载文件失败', 'danger');
        }
    }

    function renderFiles(files) {
        const container = document.getElementById('fileList');
        container.innerHTML = files.map(file => `
        <div class="col-12">
            <div class="card file-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <img src="${file.isWhitelisted ?
            'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGViZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMjhhNzQ1Ij48cGF0aCBkPSJNMTkuMjkzIDUuMjkzTDkgMTUuNTg2IDQuNzA3IDExLjI5MyAzLjI5MyAxMi43MDcgOSAxOC40MTQgMjAuNzA3IDYuNzA3eiIvPjwvc3ZnPg==' :
            'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjNmM3NTgwIj48cGF0aCBkPSJNMTkgNWgydjE0aC0ydjE0SDU2djJIMThWN0g1VjVoMTR6TTMxIDE5VjVoMTR2MThIMzF6Ii8+PC9zdmc+'}"
                             class="whitelist-icon">
                        <span class="ms-2">${file.fileName}</span>
                    </div>
                    <small class="text-muted">
                        ${new Date(file.creationTime).toLocaleDateString()}
                    </small>
                </div>
                <div class="card-body">
                    ${file.type === 'text' ? `
                        <div class="content-preview">
                            <div class="text-content-wrapper">
                                <div class="pre-line-container" id="pre-${encodeURIComponent(file.fileName)}">
                                    <div class="d-flex align-items-center text-muted">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        正在加载内容...
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : file.type === 'image' ? `
                        <img src="/api/clipboard/files/${encodeURIComponent(file.fileName)}"
                             class="img-fluid rounded"
                             loading="lazy">
                    ` : `
                        <a href="/api/clipboard/files/${encodeURIComponent(file.fileName)}"
                           class="btn btn-outline-primary w-100"
                           download="${file.fileName}">
                            下载文件
                        </a>
                    `}
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button class="btn ${file.isWhitelisted ? 'btn-danger' : 'btn-success'}"
                            onclick="toggleWhitelist('${encodeURIComponent(file.fileName)}', ${!file.isWhitelisted})">
                        ${file.isWhitelisted ? '移出白名单' : '加入保护'}
                    </button>
                    <button class="btn btn-outline-danger"
                            onclick="deleteFile('${encodeURIComponent(file.fileName)}')">
                        删除
                    </button>
                </div>
            </div>
        </div>
        `).join('');
    }

    async function loadTextContents(files) {
        const textFiles = files.filter(f => f.type === 'text');

        for (const file of textFiles) {
            const encodedFileName = encodeURIComponent(file.fileName);
            const containerId = `pre-${encodedFileName}`;
            const container = document.getElementById(containerId);

            if (!container) {
                console.error(`找不到容器: ${containerId}`);
                continue;
            }

            try {
                container.innerHTML = `
                <div class="d-flex align-items-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    正在加载内容...
                </div>
            `;

                const response = await fetch(`/api/clipboard/files/${encodedFileName}`);
                if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);
                const content = await response.text();

                // 存储原始内容用于复制
                container.dataset.fullContent = content;

                if (content.length > MAX_PREVIEW_LENGTH) {
                    container.innerHTML = `
                    <div class="text-content-wrapper">
                        <div class="pre-line" style="max-height:200px;overflow:hidden;">
                            ${escapeHtml(content)}
                        </div>
                        <button class="copy-btn" onclick="copyTextContent('${encodedFileName}', this)" title="复制内容">
                            复制
                        </button>
                        <button class="btn btn-link p-0 mt-2 show-full-btn"
                                onclick="toggleExpand('${encodedFileName}')">
                            显示完整内容
                        </button>
                    </div>
                `;
                } else {
                    container.innerHTML = `
                    <div class="text-content-wrapper">
                        <div class="pre-line">
                            ${escapeHtml(content)}
                        </div>
                        <button class="copy-btn" onclick="copyTextContent('${encodedFileName}', this)" title="复制内容">
                            复制
                        </button>
                    </div>
                `;
                }
            } catch (error) {
                console.error('内容加载失败:', error);
                container.innerHTML = `
                <div class="text-danger">
                    加载失败: ${error.message}
                    <button class="btn btn-link p-0"
                            onclick="window.loadTextContents([${JSON.stringify(file)}])">
                        重试
                    </button>
                </div>
            `;
            }
        }
    }

    // 复制文本内容功能 - 修复版本
    async function copyTextContent(encodedFileName, buttonElement) {
        try {
            const container = document.getElementById(`pre-${encodedFileName}`);
            if (!container) {
                Toast.show('找不到内容', 'danger');
                return;
            }

            const content = container.dataset.fullContent;
            if (!content) {
                Toast.show('内容未加载', 'danger');
                return;
            }

            // 使用现代Clipboard API或降级方案
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(content);
                Toast.show('内容已复制到剪贴板', 'success');
            } else {
                // 降级方案：使用textarea和execCommand
                const textArea = document.createElement('textarea');
                textArea.value = content;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        Toast.show('内容已复制到剪贴板', 'success');
                    } else {
                        throw new Error('复制命令失败');
                    }
                } catch (err) {
                    Toast.show('复制失败，请手动选择文本复制', 'danger');
                }

                document.body.removeChild(textArea);
            }

            // 添加复制成功视觉效果
            if (buttonElement) {
                const originalText = buttonElement.textContent;
                const originalClass = buttonElement.className;

                buttonElement.textContent = '已复制!';
                buttonElement.className = originalClass + ' copy-success';

                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.className = originalClass;
                }, 2000);
            }
        } catch (error) {
            console.error('复制失败:', error);
            Toast.show('复制失败: ' + error.message, 'danger');
        }
    }

    function toggleExpand(filename) {
        const encoded = encodeURIComponent(filename);
        const container = document.querySelector(`#pre-${CSS.escape(encoded)} .pre-line`);
        const button = document.querySelector(`#pre-${CSS.escape(encoded)} .show-full-btn`);
        if (container) {
            if (container.style.maxHeight === '200px' || !container.style.maxHeight) {
                container.style.maxHeight = 'none';
                if (button) button.textContent = '收起内容';
            } else {
                container.style.maxHeight = '200px';
                if (button) button.textContent = '显示完整内容';
            }
        }
    }

    function escapeHtml(unsafe) {
        return unsafe.replace(/[&<"'>]/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[m]));
    }

    async function toggleWhitelist(filename, addToWhitelist) {
        if (!confirm(`确定要${addToWhitelist ? '加入' : '移出'}白名单吗？`)) return;
        try {
            const response = await fetch(`/api/clipboard/whitelist/${filename}?addToWhitelist=${addToWhitelist}`, {
                method: 'PUT'
            });
            if (response.ok) {
                Toast.show(`已${addToWhitelist ? '加入' : '移出'}白名单`, 'success');
                await loadFiles();
            }
        } catch {
            Toast.show('操作失败', 'danger');
        }
    }

    async function deleteFile(filename) {
        if (!confirm('确定要永久删除此文件吗？')) return;
        try {
            const response = await fetch(`/api/clipboard/deleteFile/${filename}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                Toast.show('文件已删除', 'success');
                await loadFiles();
            }
        } catch {
            Toast.show('删除失败', 'danger');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('uploadForm').addEventListener('submit', async e => {
            e.preventDefault();
            await uploadFile(new FormData(e.target));
            e.target.reset();
        });

        const dropZone = document.getElementById('dropZone');
        const dropPreview = document.getElementById('dropPreview');
        const dropPreviewImage = document.getElementById('dropPreviewImage');
        const dropZoneText = document.querySelector('.drop-zone-text');

        // 处理拖放事件
        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', async e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');

            if (e.dataTransfer.files.length) {
                const formData = new FormData();
                formData.append('file', e.dataTransfer.files[0]);
                await uploadFile(formData);
            }
        });

        // 处理粘贴事件
        document.addEventListener('paste', async (e) => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    const file = new File([blob], '粘贴的图片.png', { type: 'image/png' });

                    // 显示预览
                    const objectUrl = URL.createObjectURL(blob);
                    dropPreviewImage.src = objectUrl;
                    dropZoneText.classList.add('d-none');
                    dropPreview.classList.remove('d-none');

                    // 上传图片
                    const formData = new FormData();
                    formData.append('file', file);
                    await uploadFile(formData);

                    // 重置预览
                    setTimeout(() => {
                        dropPreview.classList.add('d-none');
                        dropZoneText.classList.remove('d-none');
                        URL.revokeObjectURL(objectUrl);
                    }, 2000);

                    break;
                }
            }
        });

        loadFiles();
    });
</script>
</body>
</html>