<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云剪贴板</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --success: #28a745;
            --danger: #dc3545;
            --primary: #007bff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
        }

        .drag-over {
            border: 2px dashed var(--primary) !important;
            background-color: rgba(0, 123, 255, 0.05);
        }

        .file-card {
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 300px;
        }

        .file-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .content-preview {
            position: relative;
            max-height: none;
            overflow: visible;
        }

        .whitelist-icon {
            width: 18px;
            height: 18px;
            margin-right: 6px;
        }

        #toast {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pre-line {
            transition: max-height 0.3s ease;
            white-space: pre-wrap;
            word-break: break-word;
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            font-family: monospace;
            line-height: 1.5;
            overflow-x: auto;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 20;
            opacity: 0.7;
            transition: opacity 0.2s;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }

        .copy-btn:hover {
            opacity: 1;
            background-color: #f8f9fa;
        }

        .text-content-wrapper {
            position: relative;
        }

        .copy-success {
            background-color: var(--success) !important;
            color: white !important;
            border-color: var(--success) !important;
        }

        .drop-zone-text {
            transition: all 0.3s;
        }

        .drop-zone-hint {
            font-size: 0.85rem;
            margin-top: 8px;
            color: #6c757d;
        }

        .key-management {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .progress-container {
            margin-top: 10px;
        }

        .chunk-progress {
            height: 8px;
            border-radius: 4px;
        }

        .optimization-panel {
            background-color: #e9f7ef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .download-btn {
            position: absolute;
            top: 8px;
            right: 60px;
            z-index: 20;
            opacity: 0.7;
            transition: opacity 0.2s;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }

        .download-btn:hover {
            opacity: 1;
            background-color: #f8f9fa;
        }

        .speed-indicator {
            font-size: 0.85rem;
            margin-top: 5px;
            color: #6c757d;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <!-- AES密钥管理区域 -->
    <div class="key-management">
        <h5 class="mb-3">🔑 AES密钥管理</h5>
        <div class="mb-3">
            <label class="form-label">加密密钥</label>
            <input type="password" id="aesKeyInput" class="form-control" placeholder="输入AES加密密钥">
            <div class="form-text">用于文件加密传输，请妥善保管</div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success flex-grow-1" onclick="rememberKey()">记住密钥</button>
            <button class="btn btn-danger flex-grow-1" onclick="clearKey()">清除密钥</button>
        </div>
    </div>

    <!-- 上传优化选项 -->
    <div class="optimization-panel">
        <h5 class="mb-3">⚡ 上传优化选项</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">并行上传数</label>
                <select id="parallelUploads" class="form-select">
                    <option value="2">2个并行</option>
                    <option value="3" selected>3个并行</option>
                    <option value="4">4个并行</option>
                    <option value="5">5个并行</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">分片大小</label>
                <select id="chunkSize" class="form-select">
                    <option value="5">5MB</option>
                    <option value="10">10MB (慢速网络)</option>
                    <option value="20" selected>20MB (推荐)</option>
                    <option value="40">40MB (高速网络)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">📤 上传内容</h5>

                    <form id="uploadForm" class="mb-4">
                        <div class="mb-3">
                            <label class="form-label">文字内容</label>
                            <textarea
                                    id="textInput"
                                    name="text"
                                    class="form-control"
                                    rows="3"
                                    placeholder="输入要保存的文字..."
                            ></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">文件上传</label>
                            <input
                                    type="file"
                                    id="fileInput"
                                    name="file"
                                    class="form-control"
                            >
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <span class="upload-text">开始上传</span>
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </form>

                    <div
                            id="dropZone"
                            class="card border-dashed bg-light mb-4"
                            style="height: 160px; cursor: pointer;"
                    >
                        <div class="card-body d-flex flex-column justify-content-center text-center text-muted">
                            <div class="drop-zone-text">
                                <i class="bi bi-upload fs-3 mb-2"></i>
                                <div>拖放文件到此处上传</div>
                                <div class="drop-zone-hint">或按 Ctrl+V 粘贴图片</div>
                            </div>
                            <div id="dropPreview" class="d-none">
                                <img id="dropPreviewImage" class="img-fluid rounded mb-2" style="max-height: 100px;">
                                <div>图片已准备上传</div>
                            </div>
                        </div>
                    </div>

                    <!-- 上传进度 -->
                    <div id="uploadProgress" class="d-none">
                        <div class="d-flex justify-content-between mb-1">
                            <span>上传进度</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress chunk-progress">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="speed-indicator" id="speedIndicator">速度: 计算中...</div>
                        <div class="mt-2 text-center">
                            <button id="cancelUpload" class="btn btn-sm btn-outline-danger">取消上传</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">📂 所有文件</h5>
                    <div id="fileList" class="row g-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast align-items-center position-fixed bottom-0 start-50 translate-x-n50 mb-4 border-0"
     role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex bg-dark text-white rounded p-3">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-3 m-auto" data-bs-dismiss="toast"></button>
    </div>
</div>

<script>
    const MAX_PREVIEW_LENGTH = 1000;
    let currentUpload = {
        sessionId: null,
        file: null,
        chunks: 0,
        uploaded: 0,
        controller: null,
        isCancelled: false,
        startTime: null,
        lastUpdate: null,
        lastUploaded: 0
    };

    class Toast {
        static show(message, type = 'info') {
            const toastEl = document.getElementById('toast');
            const toastBody = toastEl.querySelector('.toast-body');
            const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-dark';
            toastEl.className = `toast show ${bgClass} text-white`;
            toastBody.textContent = message;
            setTimeout(() => toastEl.classList.remove('show'), 3000);
        }
    }

    // 密钥管理
    function rememberKey() {
        const key = document.getElementById('aesKeyInput').value;
        if (key) {
            localStorage.setItem('aesKey', key);
            Toast.show('密钥已保存', 'success');
        } else {
            Toast.show('请输入密钥', 'danger');
        }
    }

    function clearKey() {
        localStorage.removeItem('aesKey');
        document.getElementById('aesKeyInput').value = '';
        Toast.show('密钥已清除', 'success');
    }

    // 初始化密钥输入框
    document.addEventListener('DOMContentLoaded', () => {
        const savedKey = localStorage.getItem('aesKey');
        if (savedKey) {
            document.getElementById('aesKeyInput').value = savedKey;
        }
        loadFiles();
    });

    // 获取当前密钥
    function getAesKey() {
        return document.getElementById('aesKeyInput').value || localStorage.getItem('aesKey') || '';
    }

    // 密钥派生函数
    async function deriveKey(password) {
        const encoder = new TextEncoder();
        const passwordBuffer = encoder.encode(password);

        // 使用固定盐值（与后端一致）
        const salt = encoder.encode("FixedSaltValue123");

        // 导入密码作为原始密钥
        const baseKey = await crypto.subtle.importKey(
            "raw",
            passwordBuffer,
            { name: "PBKDF2" },
            false,
            ["deriveBits"]
        );

        // 使用PBKDF2派生密钥
        const derivedBits = await crypto.subtle.deriveBits(
            {
                name: "PBKDF2",
                salt: salt,
                iterations: 65536,
                hash: "SHA-256"
            },
            baseKey,
            256 // 256位密钥
        );

        // 导入为AES密钥
        return crypto.subtle.importKey(
            "raw",
            derivedBits,
            { name: "AES-CBC" },
            false,
            ["encrypt", "decrypt"]
        );
    }

    // 加密函数
    async function encryptChunk(data, password) {
        if (!password) throw new Error('未提供AES密钥');

        // 派生密钥
        const key = await deriveKey(password);

        const iv = crypto.getRandomValues(new Uint8Array(16));
        const encrypted = await crypto.subtle.encrypt(
            { name: "AES-CBC", iv },
            key,
            data
        );

        // 将IV前置到加密数据中
        const result = new Uint8Array(iv.length + encrypted.byteLength);
        result.set(iv, 0);
        result.set(new Uint8Array(encrypted), iv.length);

        return result;
    }

    // 解密函数
    async function decryptChunk(encryptedData, password) {
        if (!password) throw new Error('未提供AES密钥');

        const iv = encryptedData.slice(0, 16);
        const ciphertext = encryptedData.slice(16);

        // 派生密钥
        const key = await deriveKey(password);

        return crypto.subtle.decrypt(
            { name: "AES-CBC", iv },
            key,
            ciphertext
        );
    }

    // 上传文本
    async function uploadText(text) {
        const key = getAesKey();
        if (!key) {
            Toast.show('请先输入AES密钥', 'danger');
            return;
        }

        try {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const encrypted = await encryptChunk(data, key);

            // 转换为Base64以便传输
            const encryptedBase64 = arrayBufferToBase64(encrypted);

            const formData = new FormData();
            formData.append('text', encryptedBase64);

            const response = await fetch('/api/clipboard/uploadText', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('上传失败');
            Toast.show('文本上传成功', 'success');
            await loadFiles();
        } catch (error) {
            Toast.show(error.message, 'danger');
        }
    }

    // 上传文件（分片） - 多线程版本
    async function uploadFile(file) {
        const key = getAesKey();
        if (!key) {
            Toast.show('请先输入AES密钥', 'danger');
            return;
        }

        // 获取配置
        const parallelUploads = parseInt(document.getElementById('parallelUploads').value) || 3;
        const chunkSizeSetting = parseInt(document.getElementById('chunkSize').value) || 20;
        const chunkSize = chunkSizeSetting * 1024 * 1024; // MB转字节

        // 初始化上传状态
        currentUpload = {
            sessionId: generateUUID(),
            file: file,
            chunks: Math.ceil(file.size / chunkSize),
            uploaded: 0,
            controller: new AbortController(),
            isCancelled: false,
            startTime: Date.now(),
            lastUpdate: Date.now(),
            lastUploaded: 0
        };

        // 显示进度
        document.getElementById('uploadProgress').classList.remove('d-none');
        updateProgress();

        try {
            // 检查已上传的分片
            const response = await fetch(`/api/clipboard/checkChunks/${currentUpload.sessionId}`);
            const uploadedChunks = response.ok ? await response.json() : [];

            // 创建所有分片的上传任务
            const uploadTasks = [];
            for (let i = 0; i < currentUpload.chunks; i++) {
                if (currentUpload.isCancelled) break;

                // 跳过已上传的分片
                if (uploadedChunks.includes(i)) {
                    currentUpload.uploaded++;
                    updateProgress();
                    continue;
                }

                // 创建上传任务
                uploadTasks.push(() => uploadChunk(file, i, chunkSize, key));
            }

            // 并行执行上传任务
            await parallelExecute(uploadTasks, parallelUploads);

            if (currentUpload.isCancelled) {
                Toast.show('上传已取消', 'warning');
            } else {
                Toast.show('文件上传成功', 'success');
                await loadFiles();
            }
        } catch (error) {
            if (error.name !== 'AbortError') {
                Toast.show(`上传失败: ${error.message}`, 'danger');
            }
        } finally {
            // 重置上传状态
            document.getElementById('uploadProgress').classList.add('d-none');
            currentUpload = {
                sessionId: null,
                file: null,
                chunks: 0,
                uploaded: 0,
                controller: null,
                isCancelled: false
            };
        }
    }

    // 并行执行函数 - 实现多线程上传
    async function parallelExecute(tasks, concurrency) {
        const results = [];
        const executing = [];

        for (const task of tasks) {
            if (currentUpload.isCancelled) break;

            const p = task().then(result => {
                executing.splice(executing.indexOf(p), 1);
                return result;
            });

            executing.push(p);
            results.push(p);

            if (executing.length >= concurrency) {
                await Promise.race(executing);
            }
        }

        return Promise.all(results);
    }

    // 上传单个分片（带重试机制）
    async function uploadChunk(file, index, chunkSize, key) {
        const maxRetries = 3;
        let attempt = 0;

        while (attempt < maxRetries) {
            try {
                const start = index * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);

                // 加密分片
                const encrypted = await encryptChunk(await chunk.arrayBuffer(), key);

                // 创建FormData
                const formData = new FormData();
                formData.append('sessionId', currentUpload.sessionId);
                formData.append('chunkIndex', index.toString());
                formData.append('totalChunks', currentUpload.chunks.toString());
                formData.append('fileName', file.name);
                formData.append('data', new Blob([encrypted]));

                // 上传分片
                const response = await fetch('/api/clipboard/uploadChunk', {
                    method: 'POST',
                    body: formData,
                    signal: currentUpload.controller.signal
                });

                const result = await response.text();
                if (result.includes("文件已被合并")) {
                    // 合并已完成，跳过此分片
                    currentUpload.uploaded++;
                    updateProgress();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }

                // 更新进度
                currentUpload.uploaded++;
                updateProgress();
                return;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw error;
                }
                attempt++;
                if (attempt >= maxRetries) {
                    throw new Error(`分片 ${index} 上传失败: ${error.message}`);
                }
                // 指数退避重试
                await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt)));
            }
        }
    }

    // 下载文件
    async function downloadFile(fileName) {
        const key = getAesKey();
        if (!key) {
            Toast.show('请先输入AES密钥', 'danger');
            return;
        }

        try {
            const response = await fetch(`/api/clipboard/files/${encodeURIComponent(fileName)}`);
            if (!response.ok) throw new Error('下载失败');

            const encryptedData = await response.arrayBuffer();

            // 解密内容
            const decrypted = await decryptChunk(new Uint8Array(encryptedData), key);

            // 创建下载链接
            const blob = new Blob([decrypted]);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();

            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);

            Toast.show('文件下载成功', 'success');
        } catch (error) {
            Toast.show(`下载失败: ${error.message}`, 'danger');
        }
    }

    // 下载文本文件（未加密）
    async function downloadTextFile(fileName) {
        try {
            const response = await fetch(`/api/clipboard/downloadText/${encodeURIComponent(fileName)}`);
            if (!response.ok) throw new Error('下载失败');

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);

            Toast.show('文本下载成功', 'success');
        } catch (error) {
            Toast.show(`下载失败: ${error.message}`, 'danger');
        }
    }

    // 更新上传进度和速度
    function updateProgress() {
        const now = Date.now();
        const percent = Math.round((currentUpload.uploaded / currentUpload.chunks) * 100);

        // 计算上传速度
        if (currentUpload.lastUpdate) {
            const timeDiff = (now - currentUpload.lastUpdate) / 1000; // 秒
            const uploadedDiff = currentUpload.uploaded - currentUpload.lastUploaded;

            if (timeDiff > 0) {
                const speed = uploadedDiff / timeDiff; // 分片/秒
                const chunkSize = parseInt(document.getElementById('chunkSize').value) || 20;
                const speedMBps = (speed * chunkSize).toFixed(2);
                document.getElementById('speedIndicator').textContent = `速度: ${speedMBps} MB/s`;
            }
        }

        document.getElementById('progressBar').style.width = `${percent}%`;
        document.getElementById('progressPercent').textContent = `${percent}%`;

        // 更新状态
        currentUpload.lastUpdate = now;
        currentUpload.lastUploaded = currentUpload.uploaded;
    }

    // 取消上传
    document.getElementById('cancelUpload').addEventListener('click', () => {
        if (currentUpload.controller) {
            currentUpload.controller.abort();
            currentUpload.isCancelled = true;
        }
    });

    // 加载文件列表
    async function loadFiles() {
        try {
            const response = await fetch('/api/clipboard/queryAllFiles');
            const files = await response.json();
            renderFiles(files);
            loadTextContents(files);
        } catch (error) {
            Toast.show('加载文件失败', 'danger');
        }
    }

    function renderFiles(files) {
        const container = document.getElementById('fileList');
        container.innerHTML = files.map(file => `
        <div class="col-12">
            <div class="card file-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <img src="${file.isWhitelisted ?
            'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGViZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMjhhNzQ1Ij48cGF0aCBkPSJNMTkuMjkzIDUuMjkzTDkgMTUuNTg2IDQuNzA3IDExLjI5MyAzLjI5zIDEyLjcwNyA5IDE4LjQxNCAyMC43MDcgNi43MDd6Ii8+PC9zdmc+' :
            'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjNmM3NTgwIj48cGF0aCBkPSJNMTkgNWgydjE0aC0ydjE0SDU2djJIMThWN0g1VjVoMTR6TTMxIDE5VjVoMTR2MThIMzF6Ii8+PC9zdmc+'}"
                             class="whitelist-icon">
                        <span class="ms-2">${file.fileName}</span>
                    </div>
                    <small class="text-muted">
                        ${new Date(file.creationTime).toLocaleDateString()}
                    </small>
                </div>
                <div class="card-body">
                    ${file.type === 'text' ? `
                        <div class="content-preview">
                            <div class="text-content-wrapper">
                                <div class="pre-line-container" id="pre-${encodeURIComponent(file.fileName)}">
                                    <div class="d-flex align-items-center text-muted">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        正在加载内容...
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : file.type === 'image' ? `
                        <img src="/api/clipboard/files/${encodeURIComponent(file.fileName)}"
                             class="img-fluid rounded"
                             loading="lazy">
                    ` : `
                        <button class="btn btn-outline-primary w-100"
                                onclick="downloadFile('${encodeURIComponent(file.fileName)}')"
                                title="下载文件">
                            下载文件
                        </button>
                    `}
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button class="btn ${file.isWhitelisted ? 'btn-danger' : 'btn-success'}"
                            onclick="toggleWhitelist('${encodeURIComponent(file.fileName)}', ${!file.isWhitelisted})">
                        ${file.isWhitelisted ? '移出白名单' : '加入保护'}
                    </button>
                    <button class="btn btn-outline-danger"
                            onclick="deleteFile('${encodeURIComponent(file.fileName)}')">
                        删除
                    </button>
                </div>
            </div>
        </div>
        `).join('');
    }

    // 加载文本内容
    async function loadTextContents(files) {
        const textFiles = files.filter(f => f.type === 'text');

        for (const file of textFiles) {
            const encodedFileName = encodeURIComponent(file.fileName);
            const containerId = `pre-${encodedFileName}`;
            const container = document.getElementById(containerId);

            if (!container) {
                console.error(`找不到容器: ${containerId}`);
                continue;
            }

            try {
                container.innerHTML = `
                <div class="d-flex align-items-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    正在加载内容...
                </div>
            `;

                const response = await fetch(`/api/clipboard/files/${encodedFileName}`);
                if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);
                const encryptedData = await response.arrayBuffer();

                // 解密内容
                const key = getAesKey();
                if (!key) {
                    container.innerHTML = `
                    <div class="text-danger">
                        需要AES密钥解密内容
                        <button class="btn btn-link p-0"
                                onclick="loadTextContents([${JSON.stringify(file)}])">
                            重试
                        </button>
                    </div>
                    `;
                    continue;
                }

                const decrypted = await decryptChunk(new Uint8Array(encryptedData), key);
                const decoder = new TextDecoder();
                const content = decoder.decode(decrypted);

                // 存储原始内容用于复制
                container.dataset.fullContent = content;

                container.innerHTML = `
                <div class="text-content-wrapper">
                    <div class="pre-line">
                        ${escapeHtml(content)}
                    </div>
                    <button class="download-btn" onclick="downloadTextFile('${encodedFileName}')" title="下载文本">
                        下载
                    </button>
                    <button class="copy-btn" onclick="copyTextContent('${encodedFileName}', this)" title="复制内容">
                        复制
                    </button>
                </div>
                `;
            } catch (error) {
                console.error('内容加载失败:', error);
                container.innerHTML = `
                <div class="text-danger">
                    加载失败: ${error.message}
                    <button class="btn btn-link p-0"
                            onclick="loadTextContents([${JSON.stringify(file)}])">
                        重试
                    </button>
                </div>
            `;
            }
        }
    }

    // 复制文本内容功能
    async function copyTextContent(encodedFileName, buttonElement) {
        try {
            const container = document.getElementById(`pre-${encodedFileName}`);
            if (!container) {
                Toast.show('找不到内容', 'danger');
                return;
            }

            const content = container.dataset.fullContent;
            if (!content) {
                Toast.show('内容未加载', 'danger');
                return;
            }

            // 使用现代Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(content);
                Toast.show('内容已复制到剪贴板', 'success');
            } else {
                // 降级方案
                const textArea = document.createElement('textarea');
                textArea.value = content;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        Toast.show('内容已复制到剪贴板', 'success');
                    } else {
                        throw new Error('复制命令失败');
                    }
                } catch (err) {
                    Toast.show('复制失败，请手动选择文本复制', 'danger');
                }

                document.body.removeChild(textArea);
            }

            // 添加复制成功视觉效果
            if (buttonElement) {
                const originalText = buttonElement.textContent;
                const originalClass = buttonElement.className;

                buttonElement.textContent = '已复制!';
                buttonElement.className = originalClass + ' copy-success';

                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.className = originalClass;
                }, 2000);
            }
        } catch (error) {
            console.error('复制失败:', error);
            Toast.show('复制失败: ' + error.message, 'danger');
        }
    }

    function escapeHtml(unsafe) {
        return unsafe.replace(/[&<"'>]/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[m]));
    }

    async function toggleWhitelist(filename, addToWhitelist) {
        if (!confirm(`确定要${addToWhitelist ? '加入' : '移出'}白名单吗？`)) return;
        try {
            const response = await fetch(`/api/clipboard/whitelist/${filename}?addToWhitelist=${addToWhitelist}`, {
                method: 'PUT'
            });
            if (response.ok) {
                Toast.show(`已${addToWhitelist ? '加入' : '移出'}白名单`, 'success');
                await loadFiles();
            }
        } catch {
            Toast.show('操作失败', 'danger');
        }
    }

    async function deleteFile(filename) {
        if (!confirm('确定要永久删除此文件吗？')) return;
        try {
            const response = await fetch(`/api/clipboard/deleteFile/${filename}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                Toast.show('文件已删除', 'success');
                await loadFiles();
            }
        } catch {
            Toast.show('删除失败', 'danger');
        }
    }

    // 辅助函数
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('uploadForm').addEventListener('submit', async e => {
            e.preventDefault();

            const text = document.getElementById('textInput').value;
            const fileInput = document.getElementById('fileInput');

            if (text) {
                await uploadText(text);
            } else if (fileInput.files.length > 0) {
                await uploadFile(fileInput.files[0]);
            } else {
                Toast.show('请提供文本或文件', 'warning');
            }

            e.target.reset();
        });

        const dropZone = document.getElementById('dropZone');
        const dropPreview = document.getElementById('dropPreview');
        const dropPreviewImage = document.getElementById('dropPreviewImage');
        const dropZoneText = document.querySelector('.drop-zone-text');

        // 处理拖放事件
        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', async e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');

            if (e.dataTransfer.files.length) {
                await uploadFile(e.dataTransfer.files[0]);
            }
        });

        // 处理粘贴事件
        document.addEventListener('paste', async (e) => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    const file = new File([blob], '粘贴的图片.png', { type: 'image/png' });

                    // 显示预览
                    const objectUrl = URL.createObjectURL(blob);
                    dropPreviewImage.src = objectUrl;
                    dropZoneText.classList.add('d-none');
                    dropPreview.classList.remove('d-none');

                    // 上传图片
                    await uploadFile(file);

                    // 重置预览
                    setTimeout(() => {
                        dropPreview.classList.add('d-none');
                        dropZoneText.classList.remove('d-none');
                        URL.revokeObjectURL(objectUrl);
                    }, 2000);

                    break;
                }
            }
        });
    });
</script>
</body>
</html>