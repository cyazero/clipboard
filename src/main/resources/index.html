<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘å‰ªè´´æ¿ - æŒ‰éœ€åŠ è½½ç‰ˆ</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --success: #28a745;
            --danger: #dc3545;
            --primary: #007bff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
        }

        .drag-over {
            border: 2px dashed var(--primary) !important;
            background-color: rgba(0, 123, 255, 0.05);
        }

        .file-card {
            transition: transform 0.2s, box-shadow 0.2s;
            min-height: 300px;
        }

        .file-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .content-preview {
            position: relative;
            max-height: none;
            overflow: visible;
        }

        .whitelist-icon {
            width: 18px;
            height: 18px;
            margin-right: 6px;
        }

        /* ä¿®å¤Toastä½ç½® - æ”¹ä¸ºå³ä¸Šè§’ */
        #toast {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }

        .pre-line {
            transition: max-height 0.3s ease;
            white-space: pre-wrap;
            word-break: break-word;
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            font-family: monospace;
            line-height: 1.5;
            overflow-x: auto;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 20;
            opacity: 0.7;
            transition: opacity 0.2s;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }

        .copy-btn:hover {
            opacity: 1;
            background-color: #f8f9fa;
        }

        .text-content-wrapper {
            position: relative;
        }

        .copy-success {
            background-color: var(--success) !important;
            color: white !important;
            border-color: var(--success) !important;
        }

        .drop-zone-text {
            transition: all 0.3s;
        }

        .drop-zone-hint {
            font-size: 0.85rem;
            margin-top: 8px;
            color: #6c757d;
        }

        .key-management {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .progress-container {
            margin-top: 10px;
        }

        .chunk-progress {
            height: 8px;
            border-radius: 4px;
        }

        .optimization-panel {
            background-color: #e9f7ef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .download-btn {
            position: absolute;
            top: 8px;
            right: 60px;
            z-index: 20;
            opacity: 0.7;
            transition: opacity 0.2s;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }

        .download-btn:hover {
            opacity: 1;
            background-color: #f8f9fa;
        }

        .speed-indicator {
            font-size: 0.85rem;
            margin-top: 5px;
            color: #6c757d;
        }

        /* æ–°å¢æ ·å¼ */
        .visibility-toggle {
            position: absolute;
            top: 8px;
            right: 110px;
            z-index: 20;
            opacity: 0.7;
            transition: opacity 0.2s;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .visibility-toggle:hover {
            opacity: 1;
            background-color: #f8f9fa;
        }

        .global-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            gap: 10px;
        }

        .content-placeholder {
            background-color: #f1f1f1;
            border-radius: 4px;
            padding: 40px 20px;
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
            position: relative;
        }

        .content-placeholder i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .placeholder-controls {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 5px;
        }

        .placeholder-btn {
            opacity: 0.7;
            transition: opacity 0.2s;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .placeholder-btn:hover {
            opacity: 1;
            background-color: #f8f9fa;
        }

        .img-preview {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
        }
    </style>
</head>

<body>
<div class="container py-4">
    <!-- AESå¯†é’¥ç®¡ç†åŒºåŸŸ -->
    <div class="key-management">
        <h5 class="mb-3">ğŸ”‘ AESå¯†é’¥ç®¡ç†</h5>
        <div class="mb-3">
            <label class="form-label">åŠ å¯†å¯†é’¥</label>
            <input type="password" id="aesKeyInput" class="form-control" placeholder="è¾“å…¥AESåŠ å¯†å¯†é’¥">
            <div class="form-text">ç”¨äºæ–‡ä»¶åŠ å¯†ä¼ è¾“ï¼Œè¯·å¦¥å–„ä¿ç®¡</div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-success flex-grow-1" onclick="rememberKey()">è®°ä½å¯†é’¥</button>
            <button class="btn btn-danger flex-grow-1" onclick="clearKey()">æ¸…é™¤å¯†é’¥</button>
        </div>
    </div>

    <!-- ä¸Šä¼ ä¼˜åŒ–é€‰é¡¹ -->
    <div class="optimization-panel">
        <h5 class="mb-3">âš¡ ä¸Šä¼ ä¼˜åŒ–é€‰é¡¹</h5>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">å¹¶è¡Œä¸Šä¼ æ•°</label>
                <select id="parallelUploads" class="form-select">
                    <option value="2">2ä¸ªå¹¶è¡Œ</option>
                    <option value="3" selected>3ä¸ªå¹¶è¡Œ</option>
                    <option value="4">4ä¸ªå¹¶è¡Œ</option>
                    <option value="5">5ä¸ªå¹¶è¡Œ</option>
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">åˆ†ç‰‡å¤§å°</label>
                <select id="chunkSize" class="form-select">
                    <option value="5">5MB</option>
                    <option value="10">10MB (æ…¢é€Ÿç½‘ç»œ)</option>
                    <option value="20" selected>20MB (æ¨è)</option>
                    <option value="40">40MB (é«˜é€Ÿç½‘ç»œ)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">ğŸ“¤ ä¸Šä¼ å†…å®¹</h5>

                    <form id="uploadForm" class="mb-4">
                        <div class="mb-3">
                            <label class="form-label">æ–‡å­—å†…å®¹</label>
                            <textarea id="textInput" name="text" class="form-control" rows="3"
                                      placeholder="è¾“å…¥è¦ä¿å­˜çš„æ–‡å­—..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æ–‡ä»¶ä¸Šä¼ </label>
                            <input type="file" id="fileInput" name="file" class="form-control">
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <span class="upload-text">å¼€å§‹ä¸Šä¼ </span>
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </form>

                    <div id="dropZone" class="card border-dashed bg-light mb-4"
                         style="height: 160px; cursor: pointer;">
                        <div class="card-body d-flex flex-column justify-content-center text-center text-muted">
                            <div class="drop-zone-text">
                                <i class="bi bi-upload fs-3 mb-2"></i>
                                <div>æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                                <div class="drop-zone-hint">æˆ–æŒ‰ Ctrl+V ç²˜è´´å›¾ç‰‡</div>
                            </div>
                            <div id="dropPreview" class="d-none">
                                <img id="dropPreviewImage" class="img-fluid rounded mb-2"
                                     style="max-height: 100px;">
                                <div>å›¾ç‰‡å·²å‡†å¤‡ä¸Šä¼ </div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸Šä¼ è¿›åº¦ -->
                    <div id="uploadProgress" class="d-none">
                        <div class="d-flex justify-content-between mb-1">
                            <span>ä¸Šä¼ è¿›åº¦</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress chunk-progress">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="speed-indicator" id="speedIndicator">é€Ÿåº¦: è®¡ç®—ä¸­...</div>
                        <div class="mt-2 text-center">
                            <button id="cancelUpload" class="btn btn-sm btn-outline-danger">å–æ¶ˆä¸Šä¼ </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title m-0">ğŸ“‚ æ‰€æœ‰æ–‡ä»¶</h5>
                        <div class="global-controls">
                            <button class="btn btn-sm btn-outline-primary" onclick="showAllContent()">
                                <i class="bi bi-eye"></i> å±•ç¤ºå…¨éƒ¨
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="hideAllContent()">
                                <i class="bi bi-eye-slash"></i> éšè—å…¨éƒ¨
                            </button>
                        </div>
                    </div>
                    <div id="fileList" class="row g-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä¿®æ”¹Toastä½ç½®ä¸ºå³ä¸Šè§’ -->
<div id="toast" class="toast align-items-center border-0"
     role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex bg-dark text-white rounded p-3">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-3 m-auto" data-bs-dismiss="toast"></button>
    </div>
</div>

<script>
    const MAX_PREVIEW_LENGTH = 1000;
    let currentUpload = {
        sessionId: null,
        file: null,
        chunks: 0,
        uploaded: 0,
        controller: null,
        isCancelled: false,
        startTime: null,
        lastUpdate: null,
        lastUploaded: 0
    };

    class Toast {
        static show(message, type = 'info') {
            const toastEl = document.getElementById('toast');
            const toastBody = toastEl.querySelector('.toast-body');
            const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-dark';
            
            // æ›´æ–°Toastæ ·å¼
            toastEl.className = `toast show ${bgClass} text-white`;
            toastBody.textContent = message;
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                toastEl.classList.remove('show');
            }, 3000);
        }
    }

    // å¯†é’¥ç®¡ç†
    function rememberKey() {
        const key = document.getElementById('aesKeyInput').value;
        if (key) {
            localStorage.setItem('aesKey', key);
            Toast.show('å¯†é’¥å·²ä¿å­˜', 'success');
        } else {
            Toast.show('è¯·è¾“å…¥å¯†é’¥', 'danger');
        }
    }

    function clearKey() {
        localStorage.removeItem('aesKey');
        document.getElementById('aesKeyInput').value = '';
        Toast.show('å¯†é’¥å·²æ¸…é™¤', 'success');
    }

    // åˆå§‹åŒ–å¯†é’¥è¾“å…¥æ¡†
    document.addEventListener('DOMContentLoaded', () => {
        const savedKey = localStorage.getItem('aesKey');
        if (savedKey) {
            document.getElementById('aesKeyInput').value = savedKey;
        }
        loadFiles();
    });

    // è·å–å½“å‰å¯†é’¥
    function getAesKey() {
        return document.getElementById('aesKeyInput').value || localStorage.getItem('aesKey') || '';
    }

    // å¯†é’¥æ´¾ç”Ÿå‡½æ•°
    async function deriveKey(password) {
        const encoder = new TextEncoder();
        const passwordBuffer = encoder.encode(password);

        // ä½¿ç”¨å›ºå®šç›å€¼ï¼ˆä¸åç«¯ä¸€è‡´ï¼‰
        const salt = encoder.encode("FixedSaltValue123");

        // å¯¼å…¥å¯†ç ä½œä¸ºåŸå§‹å¯†é’¥
        const baseKey = await crypto.subtle.importKey(
            "raw",
            passwordBuffer,
            { name: "PBKDF2" },
            false,
            ["deriveBits"]
        );

        // ä½¿ç”¨PBKDF2æ´¾ç”Ÿå¯†é’¥
        const derivedBits = await crypto.subtle.deriveBits(
            {
                name: "PBKDF2",
                salt: salt,
                iterations: 65536,
                hash: "SHA-256"
            },
            baseKey,
            256 // 256ä½å¯†é’¥
        );

        // å¯¼å…¥ä¸ºAESå¯†é’¥
        return crypto.subtle.importKey(
            "raw",
            derivedBits,
            { name: "AES-CBC" },
            false,
            ["encrypt", "decrypt"]
        );
    }

    // åŠ å¯†å‡½æ•°
    async function encryptChunk(data, password) {
        if (!password) throw new Error('æœªæä¾›AESå¯†é’¥');

        // æ´¾ç”Ÿå¯†é’¥
        const key = await deriveKey(password);

        const iv = crypto.getRandomValues(new Uint8Array(16));
        const encrypted = await crypto.subtle.encrypt(
            { name: "AES-CBC", iv },
            key,
            data
        );

        // å°†IVå‰ç½®åˆ°åŠ å¯†æ•°æ®ä¸­
        const result = new Uint8Array(iv.length + encrypted.byteLength);
        result.set(iv, 0);
        result.set(new Uint8Array(encrypted), iv.length);

        return result;
    }

    // è§£å¯†å‡½æ•° - ä¿®å¤å›¾ç‰‡è§£å¯†é—®é¢˜
    async function decryptChunk(encryptedData, password) {
        if (!password) throw new Error('æœªæä¾›AESå¯†é’¥');

        // ç¡®ä¿encryptedDataæ˜¯Uint8Array
        if (!(encryptedData instanceof Uint8Array)) {
            encryptedData = new Uint8Array(encryptedData);
        }

        const iv = encryptedData.slice(0, 16);
        const ciphertext = encryptedData.slice(16);

        // æ´¾ç”Ÿå¯†é’¥
        const key = await deriveKey(password);

        return crypto.subtle.decrypt(
            { name: "AES-CBC", iv },
            key,
            ciphertext
        );
    }

    // ä¸Šä¼ æ–‡æœ¬
    async function uploadText(text) {
        const key = getAesKey();
        if (!key) {
            Toast.show('è¯·å…ˆè¾“å…¥AESå¯†é’¥', 'danger');
            return;
        }

        try {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const encrypted = await encryptChunk(data, key);

            // è½¬æ¢ä¸ºBase64ä»¥ä¾¿ä¼ è¾“
            const encryptedBase64 = arrayBufferToBase64(encrypted);

            const formData = new FormData();
            formData.append('text', encryptedBase64);

            const response = await fetch('/api/clipboard/uploadText', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('ä¸Šä¼ å¤±è´¥');
            Toast.show('æ–‡æœ¬ä¸Šä¼ æˆåŠŸ', 'success');
            await loadFiles();
        } catch (error) {
            Toast.show(error.message, 'danger');
        }
    }

    // ä¸Šä¼ æ–‡ä»¶ï¼ˆåˆ†ç‰‡ï¼‰ - å¤šçº¿ç¨‹ç‰ˆæœ¬
    async function uploadFile(file) {
        const key = getAesKey();
        if (!key) {
            Toast.show('è¯·å…ˆè¾“å…¥AESå¯†é’¥', 'danger');
            return;
        }

        // è·å–é…ç½®
        const parallelUploads = parseInt(document.getElementById('parallelUploads').value) || 3;
        const chunkSizeSetting = parseInt(document.getElementById('chunkSize').value) || 20;
        const chunkSize = chunkSizeSetting * 1024 * 1024; // MBè½¬å­—èŠ‚

        // åˆå§‹åŒ–ä¸Šä¼ çŠ¶æ€
        currentUpload = {
            sessionId: generateUUID(),
            file: file,
            chunks: Math.ceil(file.size / chunkSize),
            uploaded: 0,
            controller: new AbortController(),
            isCancelled: false,
            startTime: Date.now(),
            lastUpdate: Date.now(),
            lastUploaded: 0
        };

        // æ˜¾ç¤ºè¿›åº¦
        document.getElementById('uploadProgress').classList.remove('d-none');
        updateProgress();

        try {
            // æ£€æŸ¥å·²ä¸Šä¼ çš„åˆ†ç‰‡
            const response = await fetch(`/api/clipboard/checkChunks/${currentUpload.sessionId}`);
            const uploadedChunks = response.ok ? await response.json() : [];

            // åˆ›å»ºæ‰€æœ‰åˆ†ç‰‡çš„ä¸Šä¼ ä»»åŠ¡
            const uploadTasks = [];
            for (let i = 0; i < currentUpload.chunks; i++) {
                if (currentUpload.isCancelled) break;

                // è·³è¿‡å·²ä¸Šä¼ çš„åˆ†ç‰‡
                if (uploadedChunks.includes(i)) {
                    currentUpload.uploaded++;
                    updateProgress();
                    continue;
                }

                // åˆ›å»ºä¸Šä¼ ä»»åŠ¡
                uploadTasks.push(() => uploadChunk(file, i, chunkSize, key));
            }

            // å¹¶è¡Œæ‰§è¡Œä¸Šä¼ ä»»åŠ¡
            await parallelExecute(uploadTasks, parallelUploads);

            if (currentUpload.isCancelled) {
                Toast.show('ä¸Šä¼ å·²å–æ¶ˆ', 'warning');
            } else {
                Toast.show('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ', 'success');
                await loadFiles();
            }
        } catch (error) {
            if (error.name !== 'AbortError') {
                Toast.show(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'danger');
            }
        } finally {
            // é‡ç½®ä¸Šä¼ çŠ¶æ€
            document.getElementById('uploadProgress').classList.add('d-none');
            currentUpload = {
                sessionId: null,
                file: null,
                chunks: 0,
                uploaded: 0,
                controller: null,
                isCancelled: false
            };
        }
    }

    // å¹¶è¡Œæ‰§è¡Œå‡½æ•° - å®ç°å¤šçº¿ç¨‹ä¸Šä¼ 
    async function parallelExecute(tasks, concurrency) {
        const results = [];
        const executing = [];

        for (const task of tasks) {
            if (currentUpload.isCancelled) break;

            const p = task().then(result => {
                executing.splice(executing.indexOf(p), 1);
                return result;
            });

            executing.push(p);
            results.push(p);

            if (executing.length >= concurrency) {
                await Promise.race(executing);
            }
        }

        return Promise.all(results);
    }

    // ä¸Šä¼ å•ä¸ªåˆ†ç‰‡ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
    async function uploadChunk(file, index, chunkSize, key) {
        const maxRetries = 3;
        let attempt = 0;

        while (attempt < maxRetries) {
            try {
                const start = index * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);

                // åŠ å¯†åˆ†ç‰‡
                const encrypted = await encryptChunk(await chunk.arrayBuffer(), key);

                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('sessionId', currentUpload.sessionId);
                formData.append('chunkIndex', index.toString());
                formData.append('totalChunks', currentUpload.chunks.toString());
                formData.append('fileName', file.name);
                formData.append('data', new Blob([encrypted]));

                // ä¸Šä¼ åˆ†ç‰‡
                const response = await fetch('/api/clipboard/uploadChunk', {
                    method: 'POST',
                    body: formData,
                    signal: currentUpload.controller.signal
                });

                const result = await response.text();
                if (result.includes("æ–‡ä»¶å·²è¢«åˆå¹¶")) {
                    // åˆå¹¶å·²å®Œæˆï¼Œè·³è¿‡æ­¤åˆ†ç‰‡
                    currentUpload.uploaded++;
                    updateProgress();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                // æ›´æ–°è¿›åº¦
                currentUpload.uploaded++;
                updateProgress();
                return;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw error;
                }
                attempt++;
                if (attempt >= maxRetries) {
                    throw new Error(`åˆ†ç‰‡ ${index} ä¸Šä¼ å¤±è´¥: ${error.message}`);
                }
                // æŒ‡æ•°é€€é¿é‡è¯•
                await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt)));
            }
        }
    }

    // ä¸‹è½½æ–‡ä»¶ - ç»Ÿä¸€å¤„ç†æ‰€æœ‰æ–‡ä»¶ç±»å‹ï¼Œä¿æŒåŸå§‹äºŒè¿›åˆ¶æ•°æ®
    async function downloadFile(fileName) {
        const key = getAesKey();
        if (!key) {
            Toast.show('è¯·å…ˆè¾“å…¥AESå¯†é’¥', 'danger');
            return;
        }

        try {
            const response = await fetch(`/api/clipboard/files/${encodeURIComponent(fileName)}`);
            if (!response.ok) throw new Error('ä¸‹è½½å¤±è´¥');

            const encryptedData = await response.arrayBuffer();

            // è§£å¯†å†…å®¹ï¼Œä¿æŒåŸå§‹äºŒè¿›åˆ¶æ•°æ®
            const decrypted = await decryptChunk(new Uint8Array(encryptedData), key);

            // åˆ›å»ºä¸‹è½½é“¾æ¥ï¼Œä½¿ç”¨application/octet-streamç±»å‹ï¼Œä¿æŒåŸå§‹äºŒè¿›åˆ¶
            const blob = new Blob([decrypted], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();

            // æ¸…ç†
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);

            Toast.show('æ–‡ä»¶ä¸‹è½½æˆåŠŸ', 'success');
        } catch (error) {
            Toast.show(`ä¸‹è½½å¤±è´¥: ${error.message}`, 'danger');
        }
    }

    // æ›´æ–°ä¸Šä¼ è¿›åº¦å’Œé€Ÿåº¦
    function updateProgress() {
        const now = Date.now();
        const percent = Math.round((currentUpload.uploaded / currentUpload.chunks) * 100);

        // è®¡ç®—ä¸Šä¼ é€Ÿåº¦
        if (currentUpload.lastUpdate) {
            const timeDiff = (now - currentUpload.lastUpdate) / 1000; // ç§’
            const uploadedDiff = currentUpload.uploaded - currentUpload.lastUploaded;

            if (timeDiff > 0) {
                const speed = uploadedDiff / timeDiff; // åˆ†ç‰‡/ç§’
                const chunkSize = parseInt(document.getElementById('chunkSize').value) || 20;
                const speedMBps = (speed * chunkSize).toFixed(2);
                document.getElementById('speedIndicator').textContent = `é€Ÿåº¦: ${speedMBps} MB/s`;
            }
        }

        document.getElementById('progressBar').style.width = `${percent}%`;
        document.getElementById('progressPercent').textContent = `${percent}%`;

        // æ›´æ–°çŠ¶æ€
        currentUpload.lastUpdate = now;
        currentUpload.lastUploaded = currentUpload.uploaded;
    }

    // å–æ¶ˆä¸Šä¼ 
    document.getElementById('cancelUpload').addEventListener('click', () => {
        if (currentUpload.controller) {
            currentUpload.controller.abort();
            currentUpload.isCancelled = true;
        }
    });

    // åŠ è½½æ–‡ä»¶åˆ—è¡¨
    async function loadFiles() {
        try {
            const response = await fetch('/api/clipboard/queryAllFiles');
            const files = await response.json();
            renderFiles(files);
        } catch (error) {
            Toast.show('åŠ è½½æ–‡ä»¶å¤±è´¥', 'danger');
        }
    }

    function renderFiles(files) {
        const container = document.getElementById('fileList');
        container.innerHTML = files.map(file => `
        <div class="col-12">
            <div class="card file-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <img src="${file.isWhitelisted ?
            'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGViZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjMjhhNzQ1Ij48cGF0aCBkPSJNMTkuMjkzIDUuMjkzTDkgMTUuNTg2IDQuNzA3IDExLjI5MyAzLjI5zIDEyLjcwNyA5IDE4LjQxNCAyMC43MDcgNi43MDd6Ii8+PC9zdmc+' :
            'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjNmM3NTgwIj48cGF0aCBkPSJNMTkgNWgydjE0aC0ydjE0SDU6djJIMThWN0g1VjVoMTR6TTMxIDE5VjVoMTR2MThIMzF6Ii8+PC9zdmc+'}"
                             class="whitelist-icon">
                        <span class="ms-2">${file.fileName}</span>
                    </div>
                    <small class="text-muted">
                        ${new Date(file.creationTime).toLocaleDateString()}
                    </small>
                </div>
                <div class="card-body">
                    ${file.type === 'text' ? `
                        <div class="content-preview">
                            <div class="text-content-wrapper">
                                <div class="pre-line-container" id="pre-${encodeURIComponent(file.fileName)}">
                                    <div class="content-placeholder">
                                        <i class="bi bi-file-earmark-text"></i>
                                        å†…å®¹æœªåŠ è½½
                                        <div class="placeholder-controls">
                                            <button class="placeholder-btn" onclick="downloadFile('${encodeURIComponent(file.fileName)}')" title="ä¸‹è½½åŸå§‹æ–‡ä»¶">
                                                <i class="bi bi-download"></i>
                                            </button>
                                            <button class="placeholder-btn" onclick="toggleVisibility('${encodeURIComponent(file.fileName)}', 'text')" title="æ˜¾ç¤º/éšè—å†…å®¹">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : file.type === 'image' ? `
                        <div class="content-preview">
                            <div class="text-content-wrapper">
                                <div class="pre-line-container" id="pre-${encodeURIComponent(file.fileName)}">
                                    <div class="content-placeholder">
                                        <i class="bi bi-image"></i>
                                        å›¾ç‰‡æœªåŠ è½½
                                        <div class="placeholder-controls">
                                            <button class="placeholder-btn" onclick="downloadFile('${encodeURIComponent(file.fileName)}')" title="ä¸‹è½½åŸå§‹æ–‡ä»¶">
                                                <i class="bi bi-download"></i>
                                            </button>
                                            <button class="placeholder-btn" onclick="toggleVisibility('${encodeURIComponent(file.fileName)}', 'image')" title="æ˜¾ç¤º/éšè—å›¾ç‰‡">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="content-preview">
                            <div class="text-content-wrapper">
                                <div class="pre-line-container" id="pre-${encodeURIComponent(file.fileName)}">
                                    <button class="btn btn-outline-primary w-100"
                                            onclick="downloadFile('${encodeURIComponent(file.fileName)}')"
                                            title="ä¸‹è½½åŸå§‹æ–‡ä»¶">
                                        ä¸‹è½½åŸå§‹æ–‡ä»¶
                                    </button>
                                </div>
                            </div>
                        </div>
                    `}
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button class="btn ${file.isWhitelisted ? 'btn-danger' : 'btn-success'}"
                            onclick="toggleWhitelist('${encodeURIComponent(file.fileName)}', ${!file.isWhitelisted})">
                        ${file.isWhitelisted ? 'ç§»å‡ºç™½åå•' : 'åŠ å…¥ä¿æŠ¤'}
                    </button>
                    <button class="btn btn-outline-danger"
                            onclick="deleteFile('${encodeURIComponent(file.fileName)}')">
                        åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
        `).join('');
    }

    // åˆ‡æ¢å†…å®¹å¯è§æ€§
    async function toggleVisibility(encodedFileName, type) {
        const container = document.getElementById(`pre-${encodedFileName}`);
        if (!container) return;

        const placeholder = container.querySelector('.content-placeholder');
        const isCurrentlyVisible = !placeholder;

        // å¦‚æœå½“å‰æ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼Œåˆ™éšè—å†…å®¹
        if (isCurrentlyVisible) {
            container.innerHTML = `
                    <div class="content-placeholder">
                        <i class="bi ${type === 'text' ? 'bi-file-earmark-text' : 'bi-image'}"></i>
                        ${type === 'text' ? 'å†…å®¹å·²éšè—' : 'å›¾ç‰‡å·²éšè—'}
                        <div class="placeholder-controls">
                            <button class="placeholder-btn" onclick="downloadFile('${encodedFileName}')" title="ä¸‹è½½åŸå§‹æ–‡ä»¶">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="placeholder-btn" onclick="toggleVisibility('${encodedFileName}', '${type}')" title="æ˜¾ç¤º/éšè—å†…å®¹">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                `;

            // æ¸…ç†Blob URL
            if (container.dataset.blobUrl) {
                URL.revokeObjectURL(container.dataset.blobUrl);
                delete container.dataset.blobUrl;
            }
            return;
        }

        // å¦åˆ™åŠ è½½å†…å®¹
        container.innerHTML = `
                <div class="d-flex align-items-center text-muted" style="height: 100px; justify-content: center;">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    æ­£åœ¨åŠ è½½å†…å®¹...
                </div>
            `;

        try {
            if (type === 'text') {
                const response = await fetch(`/api/clipboard/files/${encodedFileName}`);
                if (!response.ok) throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                const encryptedData = await response.arrayBuffer();

                // è§£å¯†å†…å®¹
                const key = getAesKey();
                if (!key) {
                    container.innerHTML = `
                            <div class="content-placeholder">
                                <i class="bi bi-file-earmark-text"></i>
                                éœ€è¦AESå¯†é’¥è§£å¯†å†…å®¹
                                <div class="placeholder-controls">
                                    <button class="placeholder-btn" onclick="downloadFile('${encodedFileName}')" title="ä¸‹è½½åŸå§‹æ–‡ä»¶">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    <button class="placeholder-btn" onclick="toggleVisibility('${encodedFileName}', 'text')" title="æ˜¾ç¤º/éšè—å†…å®¹">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    return;
                }

                const decrypted = await decryptChunk(new Uint8Array(encryptedData), key);
                const decoder = new TextDecoder();
                const content = decoder.decode(decrypted);

                // å­˜å‚¨åŸå§‹å†…å®¹ç”¨äºå¤åˆ¶
                container.dataset.fullContent = content;

                container.innerHTML = `
                        <div class="pre-line">
                            ${escapeHtml(content)}
                        </div>
                        <button class="download-btn" onclick="downloadFile('${encodedFileName}')" title="ä¸‹è½½åŸå§‹æ–‡ä»¶">
                            <i class="bi bi-download"></i>
                        </button>
                        <button class="visibility-toggle" onclick="toggleVisibility('${encodedFileName}', '${type}')" title="éšè—å†…å®¹">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                        <button class="copy-btn" onclick="copyTextContent('${encodedFileName}', this)" title="å¤åˆ¶å†…å®¹">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    `;
            } else if (type === 'image') {
                const response = await fetch(`/api/clipboard/files/${encodedFileName}`);
                if (!response.ok) throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                const encryptedData = await response.arrayBuffer();

                // è§£å¯†å†…å®¹
                const key = getAesKey();
                if (!key) {
                    container.innerHTML = `
                            <div class="content-placeholder">
                                <i class="bi bi-image"></i>
                                éœ€è¦AESå¯†é’¥è§£å¯†å†…å®¹
                                <div class="placeholder-controls">
                                    <button class="placeholder-btn" onclick="downloadFile('${encodedFileName}')" title="ä¸‹è½½åŸå§‹æ–‡ä»¶">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    <button class="placeholder-btn" onclick="toggleVisibility('${encodedFileName}', 'image')" title="æ˜¾ç¤º/éšè—å›¾ç‰‡">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    return;
                }

                const decrypted = await decryptChunk(new Uint8Array(encryptedData), key);

                // ç¡®å®šå›¾ç‰‡ç±»å‹
                const fileName = decodeURIComponent(encodedFileName);
                const extension = fileName.split('.').pop().toLowerCase();
                const mimeType = `image/${extension === 'jpg' ? 'jpeg' : extension}`;

                // åˆ›å»ºBlob URL
                const blob = new Blob([decrypted], { type: mimeType });
                const blobUrl = URL.createObjectURL(blob);

                container.innerHTML = `
                        <img src="${blobUrl}" class="img-preview rounded" loading="lazy">
                        <button class="download-btn" onclick="downloadFile('${encodedFileName}')" title="ä¸‹è½½åŸå§‹æ–‡ä»¶">
                            <i class="bi bi-download"></i>
                        </button>
                        <button class="visibility-toggle" onclick="toggleVisibility('${encodedFileName}', '${type}')" title="éšè—å›¾ç‰‡">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                    `;

                // å­˜å‚¨Blob URLä»¥ä¾¿åç»­æ¸…ç†
                container.dataset.blobUrl = blobUrl;
            }
        } catch (error) {
            console.error('å†…å®¹åŠ è½½å¤±è´¥:', error);
            container.innerHTML = `
                    <div class="content-placeholder">
                        <i class="bi ${type === 'text' ? 'bi-file-earmark-text' : 'bi-image'}"></i>
                        åŠ è½½å¤±è´¥: ${error.message}
                        <div class="placeholder-controls">
                            <button class="placeholder-btn" onclick="downloadFile('${encodedFileName}')" title="ä¸‹è½½åŸå§‹æ–‡ä»¶">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="placeholder-btn" onclick="toggleVisibility('${encodedFileName}', '${type}')" title="æ˜¾ç¤º/éšè—å†…å®¹">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                `;
        }
    }

    // å¤åˆ¶æ–‡æœ¬å†…å®¹åŠŸèƒ½
    async function copyTextContent(encodedFileName, buttonElement) {
        try {
            const container = document.getElementById(`pre-${encodedFileName}`);
            if (!container) {
                Toast.show('æ‰¾ä¸åˆ°å†…å®¹', 'danger');
                return;
            }

            const content = container.dataset.fullContent;
            if (!content) {
                Toast.show('å†…å®¹æœªåŠ è½½', 'danger');
                return;
            }

            // ä½¿ç”¨ç°ä»£Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(content);
                Toast.show('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } else {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = content;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();

                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        Toast.show('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    } else {
                        throw new Error('å¤åˆ¶å‘½ä»¤å¤±è´¥');
                    }
                } catch (err) {
                    Toast.show('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶', 'danger');
                }

                document.body.removeChild(textArea);
            }

            // æ·»åŠ å¤åˆ¶æˆåŠŸè§†è§‰æ•ˆæœ
            if (buttonElement) {
                const originalHtml = buttonElement.innerHTML;
                const originalClass = buttonElement.className;

                buttonElement.innerHTML = '<i class="bi bi-check"></i>';
                buttonElement.className = originalClass + ' copy-success';

                setTimeout(() => {
                    buttonElement.innerHTML = originalHtml;
                    buttonElement.className = originalClass;
                }, 2000);
            }
        } catch (error) {
            console.error('å¤åˆ¶å¤±è´¥:', error);
            Toast.show('å¤åˆ¶å¤±è´¥: ' + error.message, 'danger');
        }
    }

    // å…¨å±€æ˜¾ç¤ºæ‰€æœ‰å†…å®¹
    function showAllContent() {
        const placeholders = document.querySelectorAll('.content-placeholder');
        placeholders.forEach(placeholder => {
            const toggleBtn = placeholder.querySelector('.placeholder-btn[title*="æ˜¾ç¤º/éšè—"]');
            if (toggleBtn) {
                const fileName = toggleBtn.onclick.toString().match(/'([^']+)'/)[1];
                const type = toggleBtn.onclick.toString().includes("'text'") ? 'text' : 'image';
                toggleVisibility(fileName, type);
            }
        });
    }

    // å…¨å±€éšè—æ‰€æœ‰å†…å®¹
    function hideAllContent() {
        const visibilityToggles = document.querySelectorAll('.visibility-toggle');
        visibilityToggles.forEach(toggle => {
            toggle.click();
        });
    }

    function escapeHtml(unsafe) {
        return unsafe.replace(/[&<"'>]/g, m => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[m]));
    }

    async function toggleWhitelist(filename, addToWhitelist) {
        if (!confirm(`ç¡®å®šè¦${addToWhitelist ? 'åŠ å…¥' : 'ç§»å‡º'}ç™½åå•å—ï¼Ÿ`)) return;
        try {
            const response = await fetch(`/api/clipboard/whitelist/${filename}?addToWhitelist=${addToWhitelist}`, {
                method: 'PUT'
            });
            if (response.ok) {
                Toast.show(`å·²${addToWhitelist ? 'åŠ å…¥' : 'ç§»å‡º'}ç™½åå•`, 'success');
                await loadFiles();
            }
        } catch {
            Toast.show('æ“ä½œå¤±è´¥', 'danger');
        }
    }

    async function deleteFile(filename) {
        if (!confirm('ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ­¤æ–‡ä»¶å—ï¼Ÿ')) return;
        try {
            const response = await fetch(`/api/clipboard/deleteFile/${filename}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                Toast.show('æ–‡ä»¶å·²åˆ é™¤', 'success');
                await loadFiles();
            }
        } catch {
            Toast.show('åˆ é™¤å¤±è´¥', 'danger');
        }
    }

    // è¾…åŠ©å‡½æ•°
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('uploadForm').addEventListener('submit', async e => {
            e.preventDefault();

            const text = document.getElementById('textInput').value;
            const fileInput = document.getElementById('fileInput');

            if (text) {
                await uploadText(text);
            } else if (fileInput.files.length > 0) {
                await uploadFile(fileInput.files[0]);
            } else {
                Toast.show('è¯·æä¾›æ–‡æœ¬æˆ–æ–‡ä»¶', 'warning');
            }

            e.target.reset();
        });

        const dropZone = document.getElementById('dropZone');
        const dropPreview = document.getElementById('dropPreview');
        const dropPreviewImage = document.getElementById('dropPreviewImage');
        const dropZoneText = document.querySelector('.drop-zone-text');

        // å¤„ç†æ‹–æ”¾äº‹ä»¶
        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', async e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');

            if (e.dataTransfer.files.length) {
                await uploadFile(e.dataTransfer.files[0]);
            }
        });

        // å¤„ç†ç²˜è´´äº‹ä»¶
        document.addEventListener('paste', async (e) => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    const file = new File([blob], 'ç²˜è´´çš„å›¾ç‰‡.png', { type: 'image/png' });

                    // æ˜¾ç¤ºé¢„è§ˆ
                    const objectUrl = URL.createObjectURL(blob);
                    dropPreviewImage.src = objectUrl;
                    dropZoneText.classList.add('d-none');
                    dropPreview.classList.remove('d-none');

                    // ä¸Šä¼ å›¾ç‰‡
                    await uploadFile(file);

                    // é‡ç½®é¢„è§ˆ
                    setTimeout(() => {
                        dropPreview.classList.add('d-none');
                        dropZoneText.classList.remove('d-none');
                        URL.revokeObjectURL(objectUrl);
                    }, 2000);

                    break;
                }
            }
        });
    });
</script>
</body>

</html>
